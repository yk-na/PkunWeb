<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>空圧先生アプリ 画面設計書 (全機能実装版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Hiragino Sans', 'ヒラギノ角ゴシック', 'メイリオ', Meiryo, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbars */
            touch-action: manipulation;
        }
        #app-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            background-color: #1f2937; /* bg-gray-800 */
        }
        .iphone-container {
            width: 393px;
            height: 852px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.15), 0 8px 10px rgba(0,0,0,0.1);
            border-radius: 40px;
            border: 10px solid #1a1a1a;
            background: linear-gradient(to bottom, #e5e7eb, #d1d5db);
            overflow: hidden;
            position: relative;
            flex-shrink: 0; /* Prevent shrinking when scaled */
            transform-origin: center center;
            transition: transform 0.2s ease-in-out;
        }
        .key {
            transition: all 0.08s ease-in-out;
            border-radius: 8px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }
        .key:active {
            transform: translateY(1px);
            box-shadow: 0 1px 1px rgba(0,0,0,0.4), inset 0 1px 1px rgba(0,0,0,0.2);
            filter: brightness(0.95);
        }
        .lcd-text {
            font-family: 'Orbitron', sans-serif;
            color: #93f2b8;
            text-shadow: 0 0 3px #34d399, 0 0 5px #34d399;
        }
        .cursor {
            background-color: rgba(52, 211, 153, 0.5);
            outline: 1px solid rgba(52, 211, 153, 0.8);
        }
        .program-card-button {
            background-color: #f3f4f6;
            color: #1f2937;
            border: 1px solid #9ca3af;
            border-radius: 4px;
            padding: 4px;
            font-size: 16px;
            text-align: center;
            line-height: 1.2;
            transition: all 0.1s ease;
            touch-action: manipulation;
        }
        .program-card-button:active {
            background-color: #d1d5db;
            transform: scale(0.97);
        }
        .modal {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: all 0.2s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal.hidden {
            pointer-events: none;
            opacity: 0;
        }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(20px) scale(0.95); }
        .input-group {
            margin-bottom: 0.75rem;
        }
        .input-label {
            display: block;
            font-weight: 500;
            color: #4b5563;
        }
        .input-field {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            border-color: #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 16px;
            -webkit-appearance: none;
        }
        #display-area.function-result-mode #display {
            display: none;
        }
        #display-area.function-result-mode #sub-display-container {
            height: 100%;
        }
    </style>
</head>
<body class="m-0 p-0">

    <div id="app-wrapper">
        <!-- iPhoneコンテナ -->
        <div id="app-container" class="iphone-container flex flex-col">
            
            <!-- 1. 表示エリア -->
            <div class="bg-gray-900 p-2 pt-8">
                <div id="display-area" class="bg-gray-800 p-3 rounded-md border-2 border-gray-700 h-40 flex flex-col">
                    <div id="sub-display-container" class="flex-grow text-lg text-right w-full relative overflow-hidden">
                        <div id="sub-display-content" class="absolute top-0 right-0 w-full whitespace-pre-wrap transition-transform duration-200 ease-in-out lcd-text" style="line-height: 1.4;"></div>
                        <div id="scroll-indicator" class="absolute right-0 top-0 bottom-0 flex flex-col justify-between text-xs lcd-text hidden">
                            <span id="scroll-up-indicator">▲</span>
                            <span id="scroll-down-indicator">▼</span>
                        </div>
                    </div>
                    <div id="display" class="flex-shrink-0 h-auto text-5xl break-all text-right w-full flex items-end justify-end lcd-text">
                        <span class="cursor">0</span>
                    </div>
                </div>
            </div>

            <!-- プログラムネームカード (ボタン化) -->
            <div class="bg-gray-300 p-3 border-y border-gray-400">
                <div class="bg-white p-2 border border-gray-400 grid grid-cols-5 gap-2 text-center">
                    <button onclick="openModal('P1')" class="program-card-button"><span class="font-bold">P1</span><br>シリンダ</button>
                    <button onclick="openModal('P2')" class="program-card-button"><span class="font-bold">P2</span><br>運動</button>
                    <button onclick="openModal('P3')" class="program-card-button"><span class="font-bold">P3</span><br>有効断面積</button>
                    <button onclick="openModal('P4')" class="program-card-button"><span class="font-bold">P4</span><br>空気消費量</button>
                    <button onclick="openModal('P5')" class="program-card-button"><span class="font-bold">P5</span><br>流量</button>
                    <button onclick="openModal('P6')" class="program-card-button"><span class="font-bold">P6</span><br>三角関数</button>
                    <button onclick="openModal('P7')" class="program-card-button"><span class="font-bold">P7</span><br>対数</button>
                    <button onclick="openModal('P8')" class="program-card-button"><span class="font-bold">P8</span><br>圧力損失</button>
                    <button onclick="openModal('P9')" class="program-card-button"><span class="font-bold">P9</span><br>タンク充填</button>
                    <button onclick="openModal('P10')" class="program-card-button"><span class="font-bold">P10</span><br>タンク放出</button>
                </div>
            </div>

            <!-- 2. キーパッドエリア -->
            <div class="bg-gray-300 p-4 flex-grow">
                <div class="grid grid-cols-5 gap-3 h-full">
                    <!-- Row 1 -->
                    <button onclick="moveCursor('left')" class="key bg-gray-500 text-white text-xl font-medium aspect-square">←</button>
                    <button onclick="moveCursor('right')" class="key bg-gray-500 text-white text-xl font-medium aspect-square">→</button>
                    <button onclick="toggleInsertMode()" class="key bg-gray-500 text-white text-lg font-medium aspect-square">INS</button>
                    <button onclick="clearDisplay('char')" class="key bg-red-700 text-white text-lg font-medium aspect-square">C</button>
                    <button onclick="clearDisplay('all')" class="key bg-red-700 text-white text-lg font-medium aspect-square">AC</button>
                    <!-- Row 2 -->
                    <button onclick="pressMemory('MC')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">MC</button>
                    <button onclick="pressMemory('MR')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">MR</button>
                    <button onclick="pressMemory('M+')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">M+</button>
                    <button onclick="pressMemory('M-')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">M-</button>
                    <button onclick="pressKey('ANS')" class="key bg-gray-800 text-white text-lg font-medium aspect-square">ANS</button>
                    <!-- Row 3 -->
                    <button onclick="pressKey('7')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">7</button>
                    <button onclick="pressKey('8')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">8</button>
                    <button onclick="pressKey('9')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">9</button>
                    <button onclick="pressOperator('÷')" class="key bg-gray-600 text-white text-xl font-medium aspect-square">÷</button>
                    <button onclick="pressOperator('×')" class="key bg-gray-600 text-white text-xl font-medium aspect-square">×</button>
                    <!-- Row 4 -->
                    <button onclick="pressKey('4')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">4</button>
                    <button onclick="pressKey('5')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">5</button>
                    <button onclick="pressKey('6')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">6</button>
                    <button onclick="pressOperator('-')" class="key bg-gray-600 text-white text-xl font-medium aspect-square">-</button>
                    <button onclick="pressOperator('+')" class="key bg-gray-600 text-white text-xl font-medium row-span-2">+</button>
                    <!-- Row 5 -->
                    <button onclick="pressKey('1')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">1</button>
                    <button onclick="pressKey('2')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">2</button>
                    <button onclick="pressKey('3')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">3</button>
                    <button onclick="pressKey('.')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">.</button>
                    <!-- Row 6 -->
                    <button onclick="pressKey('0')" class="key bg-gray-800 text-white text-xl font-medium col-span-2">0</button>
                    <button onclick="calculate()" class="key bg-gray-600 text-white text-xl font-medium col-span-2">＝</button>
                    <button onclick="toggleSizeLock()" class="key bg-gray-500 text-white aspect-square">
                        <svg id="lock-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <svg id="unlock-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
                    </button>
                </div>
            </div>

            <!-- All Modals -->
            <div id="modal-container"></div>
        </div>
    </div>

<script>
    // --- UI State & Basic Logic ---
    const displayArea = document.getElementById('display-area');
    const display = document.getElementById('display');
    const subDisplayContainer = document.getElementById('sub-display-container');
    const subDisplayContent = document.getElementById('sub-display-content');
    const scrollIndicator = document.getElementById('scroll-indicator');
    const scrollUpIndicator = document.getElementById('scroll-up-indicator');
    const scrollDownIndicator = document.getElementById('scroll-down-indicator');
    const lockIcon = document.getElementById('lock-icon');
    const unlockIcon = document.getElementById('unlock-icon');

    let expression = '0';
    let cursorPosition = 1;
    let insertMode = true;
    let isFunctionResultDisplayed = false;
    let memoryValue = 0;
    let lastAns = 0;
    let isSizeLocked = false;
    let subDisplayMessageTimeout;
    const ATMOSPHERIC_PRESSURE = 1.033;
    const G = 9.8;

    // Sub-display scroll state
    let subDisplayScrollTop = 0;
    const SUB_DISPLAY_LINE_HEIGHT = 25.2;

    // --- Core Display Functions ---
    function formatNumberString(str) {
        const parts = str.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        return parts.join('.');
    }

    function formatExpressionForDisplay(expr) {
        return expr.split(/(\s[+\-×÷]\s)/g).map(part => {
            if (!isNaN(parseFloat(part)) && !part.includes('e')) {
                return formatNumberString(part);
            }
            return part;
        }).join('');
    }

    function updateSubDisplay(text, temporary = false) {
        clearTimeout(subDisplayMessageTimeout);
        subDisplayContent.textContent = text;
        if (temporary) {
            const previousText = isFunctionResultDisplayed ? subDisplayContent.textContent : expression;
            subDisplayMessageTimeout = setTimeout(() => {
                if (subDisplayContent.textContent === text) {
                    subDisplayContent.textContent = isFunctionResultDisplayed ? previousText : expression;
                }
            }, 1500);
        }
    }

    function renderDisplayWithCursor() {
        const formattedExpression = formatExpressionForDisplay(expression);
        const displayLength = formattedExpression.length;
        
        display.classList.remove('text-5xl', 'text-4xl', 'text-3xl');
        if (displayLength > 15) {
            display.classList.add('text-3xl');
        } else if (displayLength > 11) {
            display.classList.add('text-4xl');
        } else {
            display.classList.add('text-5xl');
        }

        if (isFunctionResultDisplayed) {
            display.innerHTML = '<span class="cursor">0</span>';
            return;
        }
        
        const originalLength = expression.substring(0, cursorPosition).replace(/,/g, '').length;
        let displayCursorPos = 0;
        let realCharCount = 0;
        for (let i = 0; i < formattedExpression.length; i++) {
            if (formattedExpression[i] !== ',') {
                realCharCount++;
            }
            if (realCharCount === originalLength) {
                displayCursorPos = i + 1;
                break;
            }
        }
        if (realCharCount < originalLength) displayCursorPos = formattedExpression.length;

        const left = formattedExpression.substring(0, displayCursorPos);
        let cursorChar = formattedExpression.substring(displayCursorPos, displayCursorPos + 1) || '&nbsp;';
        const right = formattedExpression.substring(displayCursorPos + 1);
        display.innerHTML = `${left}<span class="cursor">${cursorChar}</span>${right}`;
    }
    
    // --- Unified Input Handler ---
    function insertCharacter(char) {
        if (isFunctionResultDisplayed) clearDisplay('all');
        if (expression === '0' && char !== '.') {
            expression = '';
            cursorPosition = 0;
        }

        const currentNumber = expression.split(/[\s+\-×÷]/).pop();
        if (char.match(/[0-9]/) && currentNumber.replace('.', '').length >= 15) {
            return;
        }

        const left = expression.substring(0, cursorPosition);
        const right = insertMode ? expression.substring(cursorPosition) : expression.substring(cursorPosition + 1);
        expression = left + char + right;
        cursorPosition += char.length;
        renderDisplayWithCursor();
        updateSubDisplay(expression);
    }

    // --- Key Press Handlers ---
    function pressKey(key) {
        if (key === 'ANS') insertCharacter(String(lastAns));
        else insertCharacter(key);
    }

    function pressOperator(op) {
        insertCharacter(` ${op} `);
    }

    function calculate() {
        try {
            let evalExpression = expression.replace(/,/g, '').replace(/÷/g, '/').replace(/×/g, '*');
            if (/[^0-9\.\+\-\*\/\(\)\s]/.test(evalExpression)) throw new Error("無効な文字");
            
            let result = new Function('return ' + evalExpression)();
            lastAns = result;
            updateSubDisplay(expression + ' =');
            
            const resultStr = String(result);
            if (resultStr.replace(/[\.-]/g, '').length > 15 || Math.abs(result) > 1e15 || (Math.abs(result) < 1e-9 && result !== 0) ) {
                expression = result.toExponential(9);
            } else {
                expression = resultStr;
            }
            cursorPosition = expression.length;
            renderDisplayWithCursor();
        } catch (e) {
            updateSubDisplay('式エラー');
        }
    }

    function clearDisplay(type) {
        if (type === 'all' || isFunctionResultDisplayed) {
            expression = '0';
            cursorPosition = 1;
            isFunctionResultDisplayed = false;
            displayArea.classList.remove('function-result-mode');
            updateSubDisplay('');
            scrollIndicator.classList.add('hidden');
            subDisplayContent.textContent = '';
        } else {
            if (cursorPosition > 0) {
                const left = expression.substring(0, cursorPosition - 1);
                const right = expression.substring(cursorPosition);
                expression = left + right;
                cursorPosition--;
            }
            if (expression === '') {
                expression = '0';
                cursorPosition = 1;
            }
        }
        renderDisplayWithCursor();
        if(!isFunctionResultDisplayed) updateSubDisplay(expression);
    }

    function moveCursor(direction) {
        if (isFunctionResultDisplayed) {
            const maxScroll = Math.max(0, subDisplayContent.scrollHeight - subDisplayContainer.clientHeight);
            if (direction === 'right') { // Scroll Down
                subDisplayScrollTop = Math.min(subDisplayScrollTop + SUB_DISPLAY_LINE_HEIGHT, maxScroll);
            } else { // Scroll Up
                subDisplayScrollTop = Math.max(0, subDisplayScrollTop - SUB_DISPLAY_LINE_HEIGHT);
            }
            updateSubDisplayScroll();
        } else {
            if (direction === 'left') {
                cursorPosition = Math.max(0, cursorPosition - 1);
            } else {
                cursorPosition = Math.min(expression.length, cursorPosition + 1);
            }
            renderDisplayWithCursor();
        }
    }

    function toggleInsertMode() {
        insertMode = !insertMode;
        updateSubDisplay(insertMode ? 'INS' : 'OVR', true);
    }

    function pressMemory(type) {
        let currentValue;
        try {
            currentValue = new Function('return ' + expression.replace(/,/g, '').replace(/÷/g, '/').replace(/×/g, '*'))();
        } catch(e) { currentValue = NaN; }

        switch (type) {
            case 'MC': memoryValue = 0; updateSubDisplay('メモリークリア', true); break;
            case 'MR': expression = String(memoryValue); cursorPosition = expression.length; renderDisplayWithCursor(); updateSubDisplay(expression); break;
            case 'M+': if (!isNaN(currentValue)) { memoryValue += currentValue; updateSubDisplay(`${currentValue} を加算`, true); } break;
            case 'M-': if (!isNaN(currentValue)) { memoryValue -= currentValue; updateSubDisplay(`${currentValue} を減算`, true); } break;
        }
    }
    
    // --- Modal Control & Logic ---
    function openModal(modalId) {
        const modal = document.getElementById(`modal-${modalId}`);
        if (modal) {
            modal.classList.remove('hidden');
            const content = modal.querySelector('.modal-content');
            setTimeout(() => {
                modal.style.opacity = 1;
                content.style.opacity = 1;
                content.style.transform = 'translateY(0) scale(1)';
            }, 10);
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(`modal-${modalId}`);
        if (modal) {
            const content = modal.querySelector('.modal-content');
            modal.style.opacity = 0;
            content.style.opacity = 0;
            content.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
    }

    function toggleVis(elementId, condition) {
        document.getElementById(elementId).classList.toggle('hidden', !condition);
    }
    
    // --- Calculation Engine ---
    const calculator = {
        P1: (params) => {
            const { pressure, cylinder_diameter, rod_diameter, load_info_weight, "load_info.weight": weight, "load_info.friction": friction } = params;
            const d_cm = parseFloat(cylinder_diameter) / 10.0;
            const r_cm = parseFloat(rod_diameter) / 10.0;
            const p_val = parseFloat(pressure);
            const push_area = (Math.PI / 4) * (d_cm ** 2);
            const pull_area = (Math.PI / 4) * (d_cm ** 2 - r_cm ** 2);
            const push_output = push_area * p_val;
            const pull_output = pull_area * p_val;
            let results = { "PUSH出力": `${push_output.toFixed(2)} KGF`, "PULL出力": `${pull_output.toFixed(2)} KGF` };
            if (load_info_weight === 'on') {
                const load_f = parseFloat(weight) * parseFloat(friction);
                results["負荷率(P)"] = `${((load_f / push_output) * 100).toFixed(2)} %`;
                results["負荷率(PULL)"] = `${((load_f / pull_output) * 100).toFixed(2)} %`;
            }
            return results;
        },
        P2: (params) => {
            const { pressure, s_valve, s_spicon, s_silencer, pipe_length, pipe_diameter, cylinder_diameter, rod_diameter, stroke, load_weight, load_friction } = params;
            const D = parseFloat(cylinder_diameter) / 10;
            const d = parseFloat(rod_diameter) / 10;
            const L = parseFloat(stroke) / 10;
            const P0 = parseFloat(pressure);
            const W = parseFloat(load_weight);
            const mu = parseFloat(load_friction);
            const pipe_s = (Math.PI / 4 * (parseFloat(pipe_diameter))**2) / Math.sqrt(10 * (parseFloat(pipe_length)*100) / parseFloat(pipe_diameter) + 1);
            const S2 = 1 / Math.sqrt(1/s_valve**2 + 1/s_spicon**2 + 1/s_silencer**2 + 1/pipe_s**2);
            const A1 = (Math.PI / 4) * D**2;
            const A2 = (Math.PI / 4) * (D**2 - d**2);
            const F = W * mu;
            const f = 0.06 * P0 * A1;
            const K = (F + f + (A1 - A2)) / (A1 * (P0 + 1.03));
            const t_prime = 0.003;
            const v_const = 170;
            const V0 = A2 * L;
            const delta_V = (Math.PI / 4 * (parseFloat(pipe_diameter)/10)**2) * (parseFloat(pipe_length)*100);
            const t1 = t_prime * (V0 + delta_V) / S2;
            const t2 = 0.315 * ((W / (G * 100 * P0))**0.15) / (A1**0.235 * (1 - (F + f) / (A1 * P0))) * (L**0.585) / (S2**0.17);
            const t3 = (L / v_const) * (A2 / S2);
            const T = t1 + t2 + t3;
            const max_v = (L*10) / t3;
            const E = W / (2 * G) * (max_v / 1000)**2;
            return { "動作時間": `${T.toFixed(2)} SEC`, "最大速度": `${max_v.toFixed(2)} MM/S`, "運動エネルギー": `${E.toFixed(2)} KGF-M` };
        },
        P3: (params) => {
            const { time, pressure, cylinder_diameter, rod_diameter, stroke, load_weight, load_friction } = params;
            const T = parseFloat(time);
            const P0 = parseFloat(pressure);
            const D = parseFloat(cylinder_diameter) / 10;
            const d = parseFloat(rod_diameter) / 10;
            const L = parseFloat(stroke) / 10;
            const W = parseFloat(load_weight);
            const mu = parseFloat(load_friction);
            const A1 = (Math.PI / 4) * D**2;
            const A2 = (Math.PI / 4) * (D**2 - d**2);
            const F = W * mu;
            const f = 0.06 * P0 * A1;
            const V0 = A2 * L;
            const t_prime = 0.003;
            const v_const = 170;
            const w = F / (P0 * A1);
            const V_liter = V0 / 1000;
            const SP_approx = 5.21 * (V_liter / T) * (1 + 2 * w);
            const X = t_prime * V0;
            const Y = 0.315 * ((W / (G * 100 * P0))**0.15) / (A1**0.235 * (1 - (F + f) / (A1 * P0))) * (L**0.585);
            const Z = (L * A2) / v_const;
            const S2 = (X + Z) / (T - Y / (SP_approx**0.17));
            return { "必要合成S": `${S2.toFixed(2)} mm²`, "機器Sの目安": `${(S2 * 2).toFixed(2)} mm²` };
        },
        P4: (params) => {
            let total_consumption = 0;
            let individual_consumptions = {};
            params.cylinders.forEach((cyl, i) => {
                const D = parseFloat(cyl.diameter) / 10;
                const L = parseFloat(cyl.stroke) / 10;
                const d = parseFloat(cyl.pipe_diameter) / 10;
                const l = parseFloat(cyl.pipe_length);
                const M = parseFloat(cyl.frequency);
                const Q = (Math.PI / 4) * (D**2 * L + d**2 * (l * 100)) / 1000 * (parseFloat(params.pressure) + ATMOSPHERIC_PRESSURE) / ATMOSPHERIC_PRESSURE * M;
                total_consumption += Q;
                individual_consumptions[`シリンダ${i+1}消費量`] = `${Q.toFixed(2)} L/M`;
            });
            individual_consumptions['合計消費量'] = `${total_consumption.toFixed(2)} L/M`;
            return individual_consumptions;
        },
        P5: (params) => {
            const { type, p1, p2, s, nozzle_diameter, p1_bleed } = params;
            if (type === 'flow') {
                const P1_abs = parseFloat(p1) + ATMOSPHERIC_PRESSURE;
                const P2_abs = parseFloat(p2) + ATMOSPHERIC_PRESSURE;
                let Q;
                if (P1_abs / P2_abs >= 1.89) {
                    Q = 11.1 * parseFloat(s) * P1_abs;
                } else {
                    Q = 22.2 * parseFloat(s) * Math.sqrt(P2_abs * (parseFloat(p1) - parseFloat(p2)));
                }
                return { "空気流量": `${Q.toFixed(2)} L/M` };
            } else {
                const P_abs = parseFloat(p1_bleed) + ATMOSPHERIC_PRESSURE;
                const d = parseFloat(nozzle_diameter);
                let Q;
                if (P_abs / ATMOSPHERIC_PRESSURE >= 1.89) {
                    Q = 11.1 * 0.8 * (Math.PI / 4) * d**2 * P_abs;
                } else {
                    Q = 22.2 * 0.8 * (Math.PI / 4) * d**2 * Math.sqrt(P_abs * (P_abs - ATMOSPHERIC_PRESSURE));
                }
                return { "ブリード量": `${Q.toFixed(2)} L/M` };
            }
        },
        P6: (params) => {
            const { func, value } = params;
            const val = parseFloat(value);
            let result;
            switch(func) {
                case 'sin': result = Math.sin(val * Math.PI / 180); break;
                case 'cos': result = Math.cos(val * Math.PI / 180); break;
                case 'tan': result = Math.tan(val * Math.PI / 180); break;
                case 'asin': result = Math.asin(val) * 180 / Math.PI; break;
                case 'acos': result = Math.acos(val) * 180 / Math.PI; break;
                case 'atan': result = Math.atan(val) * 180 / Math.PI; break;
            }
            return { [`${func}(${value})`]: result.toFixed(6) };
        },
        P7: (params) => {
            const { func, value } = params;
            const val = parseFloat(value);
            let result;
            if (func === 'log10') result = Math.log10(val);
            else result = Math.log(val);
            return { [`${func}(${value})`]: result.toFixed(6) };
        },
        P8: (params) => {
            const { pressure, flow, length, diameter } = params;
            const DP = (0.2466 * parseFloat(flow)**2 * parseFloat(length)) / (parseFloat(diameter)**5.31 * (parseFloat(pressure) + ATMOSPHERIC_PRESSURE));
            return { "圧力損失": `${DP.toFixed(2)} K/C` };
        },
        P9: (params) => {
            const { supply_pressure, volume, s } = params;
            const P0_abs = parseFloat(supply_pressure) + ATMOSPHERIC_PRESSURE;
            const V = parseFloat(volume);
            const S = parseFloat(s);
            let T;
            if (P0_abs / ATMOSPHERIC_PRESSURE > 1.89) {
                T = (1.285 - 1 / P0_abs) * (5.21 / 1.4) * (V / S);
            } else {
                const Px = (ATMOSPHERIC_PRESSURE - P0_abs / 2) / (P0_abs / 2);
                T = (5.21 / 1.4) * (V / S) * (Math.PI / 2 - Math.asin(Px));
            }
            return { "充填完了時間": `${T.toFixed(2)} SEC` };
        },
        P10: (params) => {
            const { initial_pressure, volume, s } = params;
            const P0_abs = parseFloat(initial_pressure) + ATMOSPHERIC_PRESSURE;
            const V = parseFloat(volume);
            const S = parseFloat(s);
            let T;
            if (P0_abs / ATMOSPHERIC_PRESSURE >= 1.89) {
                T = (7 * ((P0_abs / (1.89 * ATMOSPHERIC_PRESSURE))**0.143 - 1) + 0.945 * 1.4) * (5.21 / 1.4) * (V / S);
            } else {
                T = 5.21 * (V / S) * (P0_abs / ATMOSPHERIC_PRESSURE - 1)**0.5;
            }
            return { "放出完了時間": `${T.toFixed(2)} SEC` };
        }
    };

    function executeCalculation(functionId) {
        const form = document.getElementById(`form-${functionId}`);
        const formData = new FormData(form);
        const params = {};
        for (let [key, value] of formData.entries()) {
            params[key] = value;
        }

        if (functionId === 'P4') {
            params.cylinders = [];
            const cylinderGroups = form.querySelectorAll('.cylinder-group');
            cylinderGroups.forEach(group => {
                params.cylinders.push({
                    diameter: group.querySelector('[name=diameter]').value,
                    stroke: group.querySelector('[name=stroke]').value,
                    frequency: group.querySelector('[name=frequency]').value,
                    pipe_length: group.querySelector('[name=pipe_length]').value,
                    pipe_diameter: group.querySelector('[name=pipe_diameter]').value,
                });
            });
        }
        
        const result = calculator[functionId](params);
        displayCalculationResult(functionId, result);
        closeModal(functionId);
    }

    function displayCalculationResult(functionId, data) {
        clearDisplay('all');
        displayArea.classList.add('function-result-mode');
        const resultText = Object.entries(data).map(([key, value]) => `${key}: ${value}`).join('\n');
        
        subDisplayContent.textContent = resultText;
        subDisplayContent.style.transform = `translateY(0px)`;
        subDisplayScrollTop = 0;

        requestAnimationFrame(() => {
            const containerHeight = subDisplayContainer.clientHeight;
            const contentHeight = subDisplayContent.scrollHeight;
            
            if (contentHeight > containerHeight) {
                scrollIndicator.classList.remove('hidden');
                updateSubDisplayScroll();
            } else {
                scrollIndicator.classList.add('hidden');
            }
        });
        
        isFunctionResultDisplayed = true;
        renderDisplayWithCursor();
    }

    function updateSubDisplayScroll() {
        subDisplayContent.style.transform = `translateY(-${subDisplayScrollTop}px)`;
        scrollUpIndicator.style.visibility = subDisplayScrollTop > 0 ? 'visible' : 'hidden';
        const maxScroll = Math.max(0, subDisplayContent.scrollHeight - subDisplayContainer.clientHeight);
        scrollDownIndicator.style.visibility = subDisplayScrollTop < maxScroll ? 'visible' : 'hidden';
    }
    
    // --- Modal HTML Generation ---
    function createModal(id, title, content) {
        return `
            <div id="modal-${id}" class="modal absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
                <div class="modal-content bg-gray-100 rounded-lg shadow-xl w-full max-w-sm p-6 border-2 border-gray-300">
                    <form id="form-${id}" onsubmit="return false;">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">${title}</h2>
                        <div class="space-y-3 text-sm">${content}</div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('${id}')" class="key bg-gray-300 text-gray-800 px-4 py-2 font-medium">キャンセル</button>
                            <button type="button" onclick="executeCalculation('${id}')" class="key bg-blue-600 text-white px-4 py-2 font-bold">計算</button>
                        </div>
                    </form>
                </div>
            </div>`;
    }

    function createAllModals() {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `
            ${createModal('P1', 'シリンダ出力と負荷率', `
                <div class="input-group"><label class="input-label">作動圧力 (K/C)</label><input type="number" name="pressure" class="input-field" value="4"></div>
                <div class="input-group"><label class="input-label">シリンダ内径 (MM)</label><input type="number" name="cylinder_diameter" class="input-field" value="63"></div>
                <div class="input-group"><label class="input-label">ロッド径 (MM)</label><input type="number" name="rod_diameter" class="input-field" value="24"></div>
                <hr class="my-3"><div class="input-group"><label class="input-label">負荷計算</label><div class="mt-2"><label class="flex items-center"><input type="checkbox" name="load_info_weight" onchange="toggleVis('p1-load-inputs', this.checked)"><span class="ml-2">負荷率を計算する</span></label></div></div>
                <div id="p1-load-inputs" class="space-y-3 pl-5 hidden">
                    <div class="input-group"><label class="input-label">負荷の重量 (Kgf)</label><input type="number" name="load_info.weight" class="input-field" value="200"></div>
                    <div class="input-group"><label class="input-label">摩擦係数</label><input type="number" name="load_info.friction" class="input-field" value="0.3"></div>
                </div>
            `)}
            ${createModal('P2', '運動 (動作時間)', `
                <div class="input-group"><label class="input-label">作動圧力 (K/C)</label><input type="number" name="pressure" class="input-field" value="5"></div>
                <div class="input-group"><label class="input-label">バルブのS (mm²)</label><input type="number" name="s_valve" class="input-field" value="10"></div>
                <div class="input-group"><label class="input-label">スピコンのS (mm²)</label><input type="number" name="s_spicon" class="input-field" value="8"></div>
                <div class="input-group"><label class="input-label">サイレンサのS (mm²)</label><input type="number" name="s_silencer" class="input-field" value="15"></div>
                <div class="input-group"><label class="input-label">配管長さ (m)</label><input type="number" name="pipe_length" class="input-field" value="1"></div>
                <div class="input-group"><label class="input-label">配管内径 (mm)</label><input type="number" name="pipe_diameter" class="input-field" value="8"></div>
                <div class="input-group"><label class="input-label">シリンダ内径 (mm)</label><input type="number" name="cylinder_diameter" class="input-field" value="50"></div>
                <div class="input-group"><label class="input-label">ロッド径 (mm)</label><input type="number" name="rod_diameter" class="input-field" value="20"></div>
                <div class="input-group"><label class="input-label">ストローク (mm)</label><input type="number" name="stroke" class="input-field" value="300"></div>
                <div class="input-group"><label class="input-label">負荷重量 (Kgf)</label><input type="number" name="load_weight" class="input-field" value="49"></div>
                <div class="input-group"><label class="input-label">摩擦係数</label><input type="number" name="load_friction" class="input-field" value="0.4"></div>
            `)}
             ${createModal('P3', '有効断面積 (必要S)', `
                <div class="input-group"><label class="input-label">目標動作時間 (sec)</label><input type="number" name="time" class="input-field" value="0.8"></div>
                <div class="input-group"><label class="input-label">作動圧力 (K/C)</label><input type="number" name="pressure" class="input-field" value="5"></div>
                <div class="input-group"><label class="input-label">シリンダ内径 (mm)</label><input type="number" name="cylinder_diameter" class="input-field" value="40"></div>
                <div class="input-group"><label class="input-label">ロッド径 (mm)</label><input type="number" name="rod_diameter" class="input-field" value="16"></div>
                <div class="input-group"><label class="input-label">ストローク (mm)</label><input type="number" name="stroke" class="input-field" value="200"></div>
                <div class="input-group"><label class="input-label">負荷重量 (Kgf)</label><input type="number" name="load_weight" class="input-field" value="80"></div>
                <div class="input-group"><label class="input-label">摩擦係数</label><input type="number" name="load_friction" class="input-field" value="0.3"></div>
            `)}
            ${createModal('P4', '空気消費量', `
                <div class="input-group"><label class="input-label">作動圧力 (K/C)</label><input type="number" name="pressure" class="input-field" value="4"></div>
                <div class="input-group"><label class="input-label">シリンダの本数</label><input type="number" name="num_cylinders" class="input-field" value="2" onchange="generateCylinderInputs(this.value)"></div>
                <div id="p4-cylinder-inputs" class="space-y-4"></div>
            `)}
            ${createModal('P5', '流量', `
                <div onchange="toggleVis('p5-flow-inputs', this.querySelector(':checked').value === 'flow'); toggleVis('p5-bleed-inputs', this.querySelector(':checked').value === 'bleed')">
                    <label class="flex items-center"><input type="radio" name="type" value="flow" checked><span class="ml-2">流量</span></label>
                    <label class="flex items-center"><input type="radio" name="type" value="bleed"><span class="ml-2">ブリード量</span></label>
                </div>
                <div id="p5-flow-inputs">
                    <div class="input-group"><label class="input-label">1次側圧力 (K/C)</label><input type="number" name="p1" class="input-field" value="5"></div>
                    <div class="input-group"><label class="input-label">2次側圧力 (K/C)</label><input type="number" name="p2" class="input-field" value="3.8"></div>
                    <div class="input-group"><label class="input-label">絞り部のS (mm²)</label><input type="number" name="s" class="input-field" value="10"></div>
                </div>
                <div id="p5-bleed-inputs" class="hidden">
                    <div class="input-group"><label class="input-label">圧力 (K/C)</label><input type="number" name="p1_bleed" class="input-field" value="3"></div>
                    <div class="input-group"><label class="input-label">ノズル内径 (mm)</label><input type="number" name="nozzle_diameter" class="input-field" value="0.8"></div>
                </div>
            `)}
            ${createModal('P6', '三角関数', `
                <div class="input-group"><label class="input-label">関数</label><select name="func" class="input-field"><option value="sin">sin</option><option value="cos">cos</option><option value="tan">tan</option><option value="asin">asin</option><option value="acos">acos</option><option value="atan">atan</option></select></div>
                <div class="input-group"><label class="input-label">値 (角度 or -1~1)</label><input type="number" name="value" class="input-field" value="40"></div>
            `)}
            ${createModal('P7', '対数', `
                <div class="input-group"><label class="input-label">関数</label><select name="func" class="input-field"><option value="log10">log10</option><option value="loge">loge</option></select></div>
                <div class="input-group"><label class="input-label">値</label><input type="number" name="value" class="input-field" value="5230"></div>
            `)}
            ${createModal('P8', '圧力損失', `
                <div class="input-group"><label class="input-label">元圧力 (K/C)</label><input type="number" name="pressure" class="input-field" value="7"></div>
                <div class="input-group"><label class="input-label">流量 (l/min)</label><input type="number" name="flow" class="input-field" value="5000"></div>
                <div class="input-group"><label class="input-label">配管長さ (m)</label><input type="number" name="length" class="input-field" value="30"></div>
                <div class="input-group"><label class="input-label">配管内径 (mm)</label><input type="number" name="diameter" class="input-field" value="27.6"></div>
            `)}
            ${createModal('P9', 'タンク充填', `
                <div class="input-group"><label class="input-label">供給圧力 (K/C)</label><input type="number" name="supply_pressure" class="input-field" value="3"></div>
                <div class="input-group"><label class="input-label">タンク容積 (l)</label><input type="number" name="volume" class="input-field" value="20"></div>
                <div class="input-group"><label class="input-label">絞り部のS (mm²)</label><input type="number" name="s" class="input-field" value="12"></div>
                <input type="hidden" name="type" value="fill_time">
            `)}
            ${createModal('P10', 'タンク放出', `
                <div class="input-group"><label class="input-label">初期圧力 (K/C)</label><input type="number" name="initial_pressure" class="input-field" value="0.5"></div>
                <div class="input-group"><label class="input-label">タンク容積 (l)</label><input type="number" name="volume" class="input-field" value="200"></div>
                <div class="input-group"><label class="input-label">絞り部のS (mm²)</label><input type="number" name="s" class="input-field" value="35"></div>
            `)}
        `;
    }

    function generateCylinderInputs(count) {
        const container = document.getElementById('p4-cylinder-inputs');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            container.innerHTML += `
                <div class="cylinder-group border-t pt-2 mt-2">
                    <h4 class="font-bold mb-2">シリンダ ${i}</h4>
                    <div class="input-group"><label class="input-label">内径 (mm)</label><input type="number" name="diameter" class="input-field" value="40"></div>
                    <div class="input-group"><label class="input-label">ストローク (mm)</label><input type="number" name="stroke" class="input-field" value="100"></div>
                    <div class="input-group"><label class="input-label">動作頻度 (回/min)</label><input type="number" name="frequency" class="input-field" value="12"></div>
                    <div class="input-group"><label class="input-label">配管長さ (m)</label><input type="number" name="pipe_length" class="input-field" value="1"></div>
                    <div class="input-group"><label class="input-label">配管内径 (mm)</label><input type="number" name="pipe_diameter" class="input-field" value="6"></div>
                </div>
            `;
        }
    }

    function toggleSizeLock() {
        isSizeLocked = !isSizeLocked;
        lockIcon.classList.toggle('hidden', isSizeLocked);
        unlockIcon.classList.toggle('hidden', !isSizeLocked);
        if (!isSizeLocked) {
            adjustAppScale();
        }
        updateSubDisplay(isSizeLocked ? '画面サイズ固定 ON' : '画面サイズ固定 OFF', true);
    }

    function adjustAppScale() {
        if (isSizeLocked) return;
        const appContainer = document.getElementById('app-container');
        const baseWidth = 393;
        const baseHeight = 852;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        const scaleX = viewportWidth / baseWidth;
        const scaleY = viewportHeight / baseHeight;

        const scale = Math.min(scaleX, scaleY);

        appContainer.style.transform = `scale(${scale})`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        createAllModals();
        generateCylinderInputs(2);
        renderDisplayWithCursor();
        adjustAppScale();
    });
    window.addEventListener('resize', adjustAppScale);
</script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDrFVlpfld4tueQh%2F2eoD%2FYIRp2RSWOpM3S%2FbU0cXiI9Ut0w1Ez1ywn4UZ022cPM2vDYG0bNYXQa%2BkZdDC%2FW76YlhoWvb4cBe4YVXw8z1YGYBl04PM3nLkzGQW6WjzUx%2FJC83MwOIauNQaGs6DhsVn9OZjjqaSd5%2BZzqrUhBokEbYRKuuK9LllIapqDE8zfGJwJZvB3obb6bNOqhOUFRWJ7MI3bn2BZ%2BN%2BMHtNU4zSQhzL84T4XxaiUgXrAn27xMmZuOVJPK8cY1%2FylAI%2BVywINEc%2Bdv4FMxRHSYeN1qrg5JSwHIsNKEIIcX4B9QTuzC7sYYcT3A%2FZFkEicDZ9r9YNkfyG00qf0lfw8WUI%2FuCU65gkQjziqyXomDiUR4bdtYPobuELy7JevRdJRwKXTUGcJ8CG5nkfL4UPRwl1DaaZuF2zS2xPAyHoEUVyW1eM2oj957797IAQtYf903oD3SnsNtRTZSueYQoNZo1mx%2B6FRp4nbQv85%2BMDT6o%2FJrZ%2FPEogWNYFZQJVZGtRc9YXMVW2pc%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDrFVlpfld4tueQh/2eoD/YIRp2RSWOpM3S/bU0cXiI9Ut0w1Ez1ywn4UZ022cPM2vDYG0bNYXQa+kZdDC/W76YlhoWvb4cBe4YVXw8z1YGYBl04PM3nLkzGQW6WjzUx/JC83MwOIauNQaGs6DhsVn9OZjjqaSd5+ZzqrUhBokEbYRKuuK9LllIapqDE8zfGJwJZvB3obb6bNOqhOUFRWJ7MI3bn2BZ+N+MHtNU4zSQhzL84T4XxaiUgXrAn27xMmZuOVJPK8cY1/ylAI+VywINEc+dv4FMxRHSYeN1qrg5JSwHIsNKEIIcX4B9QTuzC7sYYcT3A/ZFkEicDZ9r9YNkfyG00qf0lfw8WUI/uCU65gkQjziqyXomDiUR4bdtYPobuELy7JevRdJRwKXTUGcJ8CG5nkfL4UPRwl1DaaZuF2zS2xPAyHoEUVyW1eM2oj957797IAQtYf903oD3SnsNtRTZSueYQoNZo1mx+6FRp4nbQv85+MDT6o/JrZ/PEogWNYFZQJVZGtRc9YXMVW2pc=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    