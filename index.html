<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>復刻☆空圧先生リベンジャー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 変更: ロゴ用のフォントを追加 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Montserrat:wght@800&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Hiragino Sans', 'ヒラギノ角ゴシック', 'メイリオ', Meiryo, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
        }
        #app-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100vw;
            height: 100vh;
            background-color: #1f2937; /* bg-gray-800 */
        }
        .iphone-container {
            width: 393px;
            height: 852px;
            box-shadow: 0 20px 30px rgba(0,0,0,0.15), 0 8px 10px rgba(0,0,0,0.1);
            border-radius: 40px;
            border: 10px solid #1a1a1a;
            background: linear-gradient(to bottom, #e5e7eb, #d1d5db);
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            transform-origin: center center;
            transition: transform 0.2s ease-in-out;
        }
        .key {
            transition: all 0.08s ease-in-out;
            border-radius: 8px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transform: scaleY(0.9);
        }
        .key:active {
            transform: translateY(1.1px) scaleY(0.9); 
            box-shadow: 0 1px 1px rgba(0,0,0,0.4), inset 0 1px 1px rgba(0,0,0,0.2);
            filter: brightness(0.95);
        }
        .lcd-text {
            font-family: 'Orbitron', sans-serif;
            color: #93f2b8;
            text-shadow: 0 0 3px #34d399, 0 0 5px #34d399;
        }
        .cursor {
            background-color: rgba(52, 211, 153, 0.5);
            outline: 1px solid rgba(52, 211, 153, 0.8);
        }
        .program-card-button {
            background-color: #f3f4f6;
            color: #1f2937;
            border: 1px solid #9ca3af;
            border-radius: 4px;
            padding: 4px;
            font-size: 14px;
            text-align: center;
            line-height: 1.2;
            transition: all 0.1s ease;
            touch-action: manipulation;
        }
        .program-card-button:active {
            background-color: #d1d5db;
            transform: scale(0.97);
        }
        .modal {
            transition: opacity 0.2s ease-in-out;
        }
        .modal-content {
            transition: all 0.2s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal.hidden {
            pointer-events: none;
            opacity: 0;
        }
        .modal.hidden .modal-content { opacity: 0; transform: translateY(20px) scale(0.95); }
        .input-group {
            margin-bottom: 0.75rem;
        }
        .input-label {
            display: block;
            font-weight: 500;
            color: #4b5563;
        }
        .input-field {
            margin-top: 0.25rem;
            display: block;
            width: 100%;
            border-color: #d1d5db;
            border-radius: 0.375rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            font-size: 16px;
            -webkit-appearance: none;
        }
        #display-area.function-result-mode #display {
            display: none;
        }
        #display-area.function-result-mode #sub-display-container {
            height: 100%;
        }
        /* 変更: ロゴ用のフォントスタイルを定義 */
        .logo-font {
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>
<body class="m-0 p-0">

    <div id="app-wrapper">
        <!-- iPhoneコンテナ -->
        <div id="app-container" class="iphone-container flex flex-col">
            
            <!-- 変更: ロゴのクラスとスタイルを調整 -->
            <div class="h-12 flex-shrink-0 flex items-center justify-end px-5">
                <span class="logo-font font-extrabold text-2xl tracking-wide" style="color: #008D74;">CKD</span>
            </div>

            <!-- 1. 表示エリア -->
            <div class="bg-gray-900 p-2 pt-2">
                <div id="display-area" class="bg-gray-800 p-3 rounded-md border-2 border-gray-700 h-40 flex flex-col">
                    <div id="sub-display-container" class="flex-grow text-lg text-right w-full relative overflow-hidden">
                        <div id="sub-display-content" class="absolute top-0 right-0 w-full whitespace-pre-wrap transition-transform duration-200 ease-in-out lcd-text" style="line-height: 1.4;"></div>
                        <div id="scroll-indicator" class="absolute right-0 top-0 bottom-0 flex flex-col justify-between text-xs lcd-text hidden">
                            <span id="scroll-up-indicator">▲</span>
                            <span id="scroll-down-indicator">▼</span>
                        </div>
                    </div>
                    <div id="display" class="flex-shrink-0 h-auto text-5xl break-all text-right w-full flex items-end justify-end lcd-text">
                        <span class="cursor">0</span>
                    </div>
                </div>
            </div>

            <!-- プログラムネームカード (ボタン化) -->
            <div class="bg-gray-300 p-3 border-y border-gray-400">
                <div class="bg-white p-2 border border-gray-400 grid grid-cols-5 gap-2 text-center">
                    <button onclick="openModal('P0')" class="program-card-button"><span class="font-bold">P0</span><br>シリンダ出力</button>
                    <button onclick="openModal('P1')" class="program-card-button"><span class="font-bold">P1</span><br>運動</button>
                    <button onclick="openModal('P2')" class="program-card-button"><span class="font-bold">P2</span><br>有効断面積</button>
                    <button onclick="openModal('P3')" class="program-card-button"><span class="font-bold">P3</span><br>空気消費量</button>
                    <button onclick="openModal('P4')" class="program-card-button"><span class="font-bold">P4</span><br>流量</button>
                    <button onclick="openModal('P5')" class="program-card-button"><span class="font-bold">P5</span><br>三角関数</button>
                    <button onclick="openModal('P6')" class="program-card-button"><span class="font-bold">P6</span><br>対数</button>
                    <button onclick="openModal('SP2')" class="program-card-button"><span class="font-bold">SP2</span><br>圧力損失</button>
                    <button onclick="openModal('SP3')" class="program-card-button"><span class="font-bold">SP3</span><br>タンク充填</button>
                    <button onclick="openModal('SP4')" class="program-card-button"><span class="font-bold">SP4</span><br>タンク放出</button>
                </div>
            </div>

            <!-- 2. キーパッドエリア -->
            <div class="bg-gray-300 p-4 flex-grow">
                <div class="grid grid-cols-5 gap-3 h-full">
                    <!-- Row 1 -->
                    <button onclick="moveCursor('left')" class="key bg-gray-500 text-white text-xl font-medium aspect-square">←</button>
                    <button onclick="moveCursor('right')" class="key bg-gray-500 text-white text-xl font-medium aspect-square">→</button>
                    <button onclick="toggleInsertMode()" class="key bg-gray-500 text-white text-lg font-medium aspect-square">INS</button>
                    <button onclick="clearDisplay('char')" class="key bg-red-700 text-white text-lg font-medium aspect-square">C</button>
                    <button onclick="clearDisplay('all')" class="key bg-red-700 text-white text-lg font-medium aspect-square">AC</button>
                    <!-- Row 2 -->
                    <button onclick="pressMemory('MC')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">MC</button>
                    <button onclick="pressMemory('MR')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">MR</button>
                    <button onclick="pressMemory('M+')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">M+</button>
                    <button onclick="pressMemory('M-')" class="key bg-blue-700 text-white text-lg font-medium aspect-square">M-</button>
                    <button onclick="pressKey('ANS')" class="key bg-gray-800 text-white text-lg font-medium aspect-square">ANS</button>
                    <!-- Row 3 -->
                    <button onclick="pressKey('7')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">7</button>
                    <button onclick="pressKey('8')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">8</button>
                    <button onclick="pressKey('9')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">9</button>
                    <button onclick="pressOperator('÷')" class="key bg-gray-600 text-white text-xl font-medium aspect-square">÷</button>
                    <button onclick="pressOperator('×')" class="key bg-gray-600 text-white text-xl font-medium aspect-square">×</button>
                    <!-- Row 4 -->
                    <button onclick="pressKey('4')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">4</button>
                    <button onclick="pressKey('5')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">5</button>
                    <button onclick="pressKey('6')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">6</button>
                    <button onclick="pressOperator('-')" class="key bg-gray-600 text-white text-xl font-medium aspect-square">-</button>
                    <button onclick="pressOperator('+')" class="key bg-gray-600 text-white text-xl font-medium row-span-2">+</button>
                    <!-- Row 5 -->
                    <button onclick="pressKey('1')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">1</button>
                    <button onclick="pressKey('2')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">2</button>
                    <button onclick="pressKey('3')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">3</button>
                    <button onclick="pressKey('.')" class="key bg-gray-800 text-white text-xl font-medium aspect-square">.</button>
                    <!-- Row 6 -->
                    <button onclick="pressKey('0')" class="key bg-gray-800 text-white text-xl font-medium col-span-2">0</button>
                    <button onclick="calculate()" class="key bg-gray-600 text-white text-xl font-medium col-span-2">＝</button>
                    <button onclick="toggleSizeLock()" class="key bg-gray-500 text-white aspect-square">
                        <svg id="lock-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                        <svg id="unlock-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
                    </button>
                </div>
            </div>

            <!-- All Modals -->
            <div id="modal-container"></div>
        </div>
    </div>

<script>
    // --- UI State & Basic Logic ---
    const displayArea = document.getElementById('display-area');
    const display = document.getElementById('display');
    const subDisplayContainer = document.getElementById('sub-display-container');
    const subDisplayContent = document.getElementById('sub-display-content');
    const scrollIndicator = document.getElementById('scroll-indicator');
    const scrollUpIndicator = document.getElementById('scroll-up-indicator');
    const scrollDownIndicator = document.getElementById('scroll-down-indicator');
    const lockIcon = document.getElementById('lock-icon');
    const unlockIcon = document.getElementById('unlock-icon');

    let expression = '0';
    let cursorPosition = 1;
    let insertMode = true;
    let isFunctionResultDisplayed = false;
    let memoryValue = 0;
    let lastAns = 0;
    let isSizeLocked = false;
    let subDisplayMessageTimeout;
    const ATMOSPHERIC_PRESSURE = 1.033;
    const G = 9.8;
    const G_CM = 980;

    // Sub-display scroll state
    let subDisplayScrollTop = 0;
    const SUB_DISPLAY_LINE_HEIGHT = 25.2;

    // --- Core Display Functions ---
    function formatNumberString(str) {
        const parts = str.split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        return parts.join('.');
    }

    function formatExpressionForDisplay(expr) {
        return expr.split(/(\s[+\-×÷]\s)/g).map(part => {
            if (!isNaN(parseFloat(part)) && !part.includes('e')) {
                return formatNumberString(part);
            }
            return part;
        }).join('');
    }

    function updateSubDisplay(text, temporary = false) {
        clearTimeout(subDisplayMessageTimeout);
        subDisplayContent.textContent = text;
        if (temporary) {
            const previousText = isFunctionResultDisplayed ? subDisplayContent.textContent : expression;
            subDisplayMessageTimeout = setTimeout(() => {
                if (subDisplayContent.textContent === text) {
                    subDisplayContent.textContent = isFunctionResultDisplayed ? previousText : expression;
                }
            }, 1500);
        }
    }

    function renderDisplayWithCursor() {
        const formattedExpression = formatExpressionForDisplay(expression);
        const displayLength = formattedExpression.length;
        
        display.classList.remove('text-5xl', 'text-4xl', 'text-3xl');
        if (displayLength > 15) {
            display.classList.add('text-3xl');
        } else if (displayLength > 11) {
            display.classList.add('text-4xl');
        } else {
            display.classList.add('text-5xl');
        }

        if (isFunctionResultDisplayed) {
            display.innerHTML = '<span class="cursor">0</span>';
            return;
        }
        
        const originalLength = expression.substring(0, cursorPosition).replace(/,/g, '').length;
        let displayCursorPos = 0;
        let realCharCount = 0;
        for (let i = 0; i < formattedExpression.length; i++) {
            if (formattedExpression[i] !== ',') {
                realCharCount++;
            }
            if (realCharCount === originalLength) {
                displayCursorPos = i + 1;
                break;
            }
        }
        if (realCharCount < originalLength) displayCursorPos = formattedExpression.length;

        const left = formattedExpression.substring(0, displayCursorPos);
        let cursorChar = formattedExpression.substring(displayCursorPos, displayCursorPos + 1) || '&nbsp;';
        const right = formattedExpression.substring(displayCursorPos + 1);
        display.innerHTML = `${left}<span class="cursor">${cursorChar}</span>${right}`;
    }
    
    // --- Unified Input Handler ---
    function insertCharacter(char) {
        if (isFunctionResultDisplayed) clearDisplay('all');
        if (expression === '0' && char !== '.') {
            expression = '';
            cursorPosition = 0;
        }

        const currentNumber = expression.split(/[\s+\-×÷]/).pop();
        if (char.match(/[0-9]/) && currentNumber.replace('.', '').length >= 15) {
            return;
        }

        const left = expression.substring(0, cursorPosition);
        const right = insertMode ? expression.substring(cursorPosition) : expression.substring(cursorPosition + 1);
        expression = left + char + right;
        cursorPosition += char.length;
        renderDisplayWithCursor();
        updateSubDisplay(expression);
    }

    // --- Key Press Handlers ---
    function pressKey(key) {
        if (key === 'ANS') insertCharacter(String(lastAns));
        else insertCharacter(key);
    }

    function pressOperator(op) {
        insertCharacter(` ${op} `);
    }

    function calculate() {
        try {
            let evalExpression = expression.replace(/,/g, '').replace(/÷/g, '/').replace(/×/g, '*');
            if (/[^0-9\.\+\-\*\/\(\)\s]/.test(evalExpression)) throw new Error("無効な文字");
            
            let result = new Function('return ' + evalExpression)();
            lastAns = result;
            updateSubDisplay(expression + ' =');
            
            const resultStr = String(result);
            if (resultStr.replace(/[\.-]/g, '').length > 15 || Math.abs(result) > 1e15 || (Math.abs(result) < 1e-9 && result !== 0) ) {
                expression = result.toExponential(9);
            } else {
                expression = resultStr;
            }
            cursorPosition = expression.length;
            renderDisplayWithCursor();
        } catch (e) {
            updateSubDisplay('式エラー');
        }
    }

    function clearDisplay(type) {
        if (type === 'all' || isFunctionResultDisplayed) {
            expression = '0';
            cursorPosition = 1;
            isFunctionResultDisplayed = false;
            displayArea.classList.remove('function-result-mode');
            updateSubDisplay('');
            scrollIndicator.classList.add('hidden');
            subDisplayContent.textContent = '';
        } else {
            if (cursorPosition > 0) {
                const left = expression.substring(0, cursorPosition - 1);
                const right = expression.substring(cursorPosition);
                expression = left + right;
                cursorPosition--;
            }
            if (expression === '') {
                expression = '0';
                cursorPosition = 1;
            }
        }
        renderDisplayWithCursor();
        if(!isFunctionResultDisplayed) updateSubDisplay(expression);
    }

    function moveCursor(direction) {
        if (isFunctionResultDisplayed) {
            const maxScroll = Math.max(0, subDisplayContent.scrollHeight - subDisplayContainer.clientHeight);
            if (direction === 'right') { // Scroll Down
                subDisplayScrollTop = Math.min(subDisplayScrollTop + SUB_DISPLAY_LINE_HEIGHT, maxScroll);
            } else { // Scroll Up
                subDisplayScrollTop = Math.max(0, subDisplayScrollTop - SUB_DISPLAY_LINE_HEIGHT);
            }
            updateSubDisplayScroll();
        } else {
            if (direction === 'left') {
                cursorPosition = Math.max(0, cursorPosition - 1);
            } else {
                cursorPosition = Math.min(expression.length, cursorPosition + 1);
            }
            renderDisplayWithCursor();
        }
    }

    function toggleInsertMode() {
        insertMode = !insertMode;
        updateSubDisplay(insertMode ? 'INS' : 'OVR', true);
    }

    function pressMemory(type) {
        let currentValue;
        try {
            currentValue = new Function('return ' + expression.replace(/,/g, '').replace(/÷/g, '/').replace(/×/g, '*'))();
        } catch(e) { currentValue = NaN; }

        switch (type) {
            case 'MC': memoryValue = 0; updateSubDisplay('メモリークリア', true); break;
            case 'MR': expression = String(memoryValue); cursorPosition = expression.length; renderDisplayWithCursor(); updateSubDisplay(expression); break;
            case 'M+': if (!isNaN(currentValue)) { memoryValue += currentValue; updateSubDisplay(`${currentValue} を加算`, true); } break;
            case 'M-': if (!isNaN(currentValue)) { memoryValue -= currentValue; updateSubDisplay(`${currentValue} を減算`, true); } break;
        }
    }
    
    // --- Modal Control & Logic ---
    function openModal(modalId) {
        const modal = document.getElementById(`modal-${modalId}`);
        if (modal) {
            modal.classList.remove('hidden');
            const content = modal.querySelector('.modal-content');
            setTimeout(() => {
                modal.style.opacity = 1;
                content.style.opacity = 1;
                content.style.transform = 'translateY(0) scale(1)';
            }, 10);
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(`modal-${modalId}`);
        if (modal) {
            const content = modal.querySelector('.modal-content');
            modal.style.opacity = 0;
            content.style.opacity = 0;
            content.style.transform = 'translateY(20px) scale(0.95)';
            setTimeout(() => modal.classList.add('hidden'), 200);
        }
    }

    function toggleVis(elementId, condition) {
        document.getElementById(elementId).classList.toggle('hidden', !condition);
    }

    function handleUnitChange(radio) {
        const MPA_TO_KGF = 10.19716;
        const KGF_TO_MPA = 0.0980665;
        
        const inputGroup = radio.closest('.input-group');
        if (!inputGroup) return;

        const numberInput = inputGroup.querySelector('input[type=number]');
        if (!numberInput) return;

        let currentValue = parseFloat(numberInput.value);

        if (isNaN(currentValue)) return;

        if (radio.value === 'K/C') {
            numberInput.value = (currentValue * MPA_TO_KGF).toFixed(2);
        } else {
            numberInput.value = (currentValue * KGF_TO_MPA).toFixed(3);
        }
    }
    
    // --- Calculation Engine (No changes below this line) ---
    const calculator = {
        graphTPrime: {
            push: [
                { lambda: 0,    points: [[0,0], [0.001,0.25], [0.002,0.42], [0.003,0.55], [0.004,0.65], [0.005,0.72], [0.006,0.78], [0.007,0.83]] },
                { lambda: 0.05, points: [[0,0], [0.001,0.28], [0.002,0.46], [0.003,0.60], [0.004,0.69], [0.005,0.76], [0.006,0.81], [0.007,0.85]] },
                { lambda: 0.1,  points: [[0,0], [0.001,0.31], [0.002,0.50], [0.003,0.64], [0.004,0.73], [0.005,0.79], [0.006,0.84], [0.007,0.88]] },
                { lambda: 0.15, points: [[0,0], [0.001,0.34], [0.002,0.54], [0.003,0.68], [0.004,0.76], [0.005,0.82], [0.006,0.86], [0.007,0.90]] },
                { lambda: 0.2,  points: [[0,0], [0.001,0.37], [0.002,0.58], [0.003,0.71], [0.004,0.79], [0.005,0.84], [0.006,0.88], [0.007,0.92]] },
                { lambda: 0.25, points: [[0,0], [0.001,0.40], [0.002,0.61], [0.003,0.74], [0.004,0.81], [0.005,0.86], [0.006,0.90], [0.007,0.93]] },
                { lambda: 0.3,  points: [[0,0], [0.001,0.43], [0.002,0.64], [0.003,0.77], [0.004,0.83], [0.005,0.88], [0.006,0.92], [0.007,0.95]] }
            ],
            pull: [
                { lambda: 0,    points: [[0,0], [0.001,0.25], [0.002,0.42], [0.003,0.55], [0.004,0.65], [0.005,0.72], [0.006,0.78], [0.007,0.83]] },
                { lambda: 0.05, points: [[0,0], [0.001,0.22], [0.002,0.38], [0.003,0.51], [0.004,0.61], [0.005,0.69], [0.006,0.75], [0.007,0.80]] },
                { lambda: 0.1,  points: [[0,0], [0.001,0.19], [0.002,0.34], [0.003,0.47], [0.004,0.57], [0.005,0.66], [0.006,0.72], [0.007,0.77]] },
                { lambda: 0.15, points: [[0,0], [0.001,0.16], [0.002,0.30], [0.003,0.43], [0.004,0.53], [0.005,0.62], [0.006,0.69], [0.007,0.74]] },
                { lambda: 0.2,  points: [[0,0], [0.001,0.13], [0.002,0.26], [0.003,0.39], [0.004,0.49], [0.005,0.58], [0.006,0.65], [0.007,0.71]] },
                { lambda: 0.25, points: [[0,0], [0.001,0.10], [0.002,0.22], [0.003,0.35], [0.004,0.45], [0.005,0.54], [0.006,0.61], [0.007,0.68]] },
                { lambda: 0.3,  points: [[0,0], [0.001,0.07], [0.002,0.18], [0.003,0.31], [0.004,0.41], [0.005,0.50], [0.006,0.57], [0.007,0.64]] }
            ]
        },
        graphV: [
            [-0.1, 192], [0, 192], [0.1, 188], [0.2, 185], [0.3, 181], 
            [0.4, 177], [0.5, 172], [0.6, 165], [0.7, 155]
        ],
        interpolate1D(x, points) {
            if (x <= points[0][0]) return points[0][1];
            if (x >= points[points.length - 1][0]) return points[points.length - 1][1];
            for (let i = 0; i < points.length - 1; i++) {
                if (x >= points[i][0] && x <= points[i + 1][0]) {
                    const x1 = points[i][0], y1 = points[i][1];
                    const x2 = points[i+1][0], y2 = points[i+1][1];
                    return y1 + (y2 - y1) * (x - x1) / (x2 - x1);
                }
            }
            return points[points.length - 1][1];
        },
        interpolate2D(targetX, targetY, curves) {
            const yValues = curves.map(c => c.lambda);
            if (targetY <= yValues[0]) return this.interpolate1D(targetX, curves[0].points.map(([x,y]) => [y,x]));
            if (targetY >= yValues[yValues.length - 1]) return this.interpolate1D(targetX, curves[curves.length - 1].points.map(([x,y]) => [y,x]));

            let lowerCurve, upperCurve;
            for (let i = 0; i < yValues.length - 1; i++) {
                if (targetY >= yValues[i] && targetY <= yValues[i+1]) {
                    lowerCurve = curves[i];
                    upperCurve = curves[i+1];
                    break;
                }
            }
            const lowerX = this.interpolate1D(targetX, lowerCurve.points.map(([x,y]) => [y,x]));
            const upperX = this.interpolate1D(targetX, upperCurve.points.map(([x,y]) => [y,x]));
            const yRatio = (targetY - lowerCurve.lambda) / (upperCurve.lambda - lowerCurve.lambda);
            return lowerX + (upperX - lowerX) * yRatio;
        },
        P0(params) {
            const { type } = params;
            const p_val = parseFloat(params.pressure);
            const d_cm = parseFloat(params.cylinder_diameter) / 10.0;
            const r_cm = parseFloat(params.rod_diameter) / 10.0;
            
            const push_area = (Math.PI / 4) * (d_cm ** 2);
            const pull_area = (Math.PI / 4) * (d_cm ** 2 - r_cm ** 2);
            const push_output = push_area * p_val;
            const pull_output = pull_area * p_val;
            
            if (type === 'output') {
                return { "PUSH出力": `${push_output.toFixed(2)} KGF`, "PULL出力": `${pull_output.toFixed(2)} KGF` };
            } else {
                const load_f = parseFloat(params.load_weight) * parseFloat(params.load_friction);
                return { 
                    "PUSH出力": `${push_output.toFixed(2)} KGF`, 
                    "PULL出力": `${pull_output.toFixed(2)} KGF`,
                    "負荷率(PUSH)": `${((load_f / push_output) * 100).toFixed(2)} %`,
                    "負荷率(PULL)": `${((load_f / pull_output) * 100).toFixed(2)} %`
                };
            }
        },
        P1(params) {
            const { type, direction } = params;
            const P0 = parseFloat(params.pressure);
            const D_cm = parseFloat(params.cylinder_diameter) / 10;
            const d_cm = parseFloat(params.rod_diameter) / 10;
            const L_cm = parseFloat(params.stroke) / 10;
            const W_kgf = parseFloat(params.load_weight);
            const mu = parseFloat(params.load_friction);
            
            let A1, A2;
            if (direction === 'push') {
                A1 = (Math.PI / 4) * D_cm**2;
                A2 = (Math.PI / 4) * (D_cm**2 - d_cm**2);
            } else {
                A1 = (Math.PI / 4) * (D_cm**2 - d_cm**2);
                A2 = (Math.PI / 4) * D_cm**2;
            }
            const F = W_kgf * mu;
            const V0_cm3 = A2 * L_cm;
            const f = 0.06 * P0 * A1;
            const lambda = d_cm**2 / D_cm**2;
            const K = (F + f) / (A1 * P0);
            
            if (type === 'time') {
                const S2 = parseFloat(params.s_composite);
                const delta_V_cm3 = parseFloat(params.pipe_volume);

                const t_prime = this.interpolate2D(K, lambda, this.graphTPrime[direction]);
                const v_const = this.interpolate1D(K, this.graphV);

                const t1 = t_prime * (V0_cm3 + delta_V_cm3) / S2;
                const t2_num = 0.315 * Math.pow(W_kgf / (G_CM * P0), 0.15) * Math.pow(L_cm, 0.585);
                const t2_den = Math.pow(A1, 0.235) * (1 - (F + f) / (A1 * P0)) * Math.pow(S2, 0.17);
                const t2 = t2_num / t2_den;
                const t3 = (L_cm / v_const) * (A2 / S2);
                const T = t1 + t2 + t3;
                const max_v_mms = (L_cm*10) / t3;
                const E_kgfm = W_kgf / (2 * G) * (max_v_mms / 1000)**2;
                
                return { "動作時間": `${T.toFixed(2)} SEC`, "最大速度": `${max_v_mms.toFixed(2)} MM/S`, "運動エネルギー": `${E_kgfm.toFixed(2)} KGF-M` };

            } else {
                const T = parseFloat(params.time);
                const v_const = this.interpolate1D(K, this.graphV);
                const w = F / (P0 * A1);
                const V_liter = V0_cm3 / 1000;
                const SP_approx = 5.21 * (V_liter / T) * (1 + 2 * w);

                const t_prime = this.interpolate2D(K, lambda, this.graphTPrime[direction]);
                const X = t_prime * V0_cm3;
                const Y_num = 0.315 * Math.pow(W_kgf / (G_CM * P0), 0.15) * Math.pow(L_cm, 0.585);
                const Y_den = Math.pow(A1, 0.235) * (1 - (F + f) / (A1 * P0));
                const Y = Y_num / Y_den;
                const Z = (L_cm * A2) / v_const;

                const S2 = (X + Z) / (T - Y / Math.pow(SP_approx, 0.17));
                return { "必要合成S": `${S2.toFixed(2)} mm²`, "機器Sの目安": `${(S2 * 2).toFixed(2)} mm²` };
            }
        },
        P2(params) {
            const { type } = params;
            if (type === 'pipe') {
                const l = parseFloat(params.pipe_length);
                const d = parseFloat(params.pipe_diameter);
                const pipe_type = params.pipe_type;
                const lambda = pipe_type === 'nylon' ? 10 : 15;
                const S = (Math.PI / 4 * d**2) / Math.sqrt(lambda * (l*1000) / d + 1);
                return { "配管の有効断面積": `${S.toFixed(2)} mm²` };
            } else {
                const s_values = params.s_values.split(',').map(Number);
                const sum_inv_sq = s_values.reduce((acc, s) => acc + (1 / s**2), 0);
                const S_composite = 1 / Math.sqrt(sum_inv_sq);
                return { "合成有効断面積": `${S_composite.toFixed(2)} mm²` };
            }
        },
        P3(params) {
            let total_consumption = 0;
            let individual_consumptions = {};
            params.cylinders.forEach((cyl, i) => {
                const D_cm = parseFloat(cyl.diameter) / 10;
                const L_cm = parseFloat(cyl.stroke) / 10;
                const d_cm = parseFloat(cyl.pipe_diameter) / 10;
                const l_m = parseFloat(cyl.pipe_length);
                const M = parseFloat(cyl.frequency);
                const P = parseFloat(params.pressure);
                const Q = (Math.PI / 4) * (D_cm**2 * L_cm + d_cm**2 * (l_m * 100)) / 1000 * ((P + ATMOSPHERIC_PRESSURE) / ATMOSPHERIC_PRESSURE) * M;
                total_consumption += Q;
                individual_consumptions[`シリンダ${i+1}消費量`] = `${Q.toFixed(2)} L/M`;
            });
            individual_consumptions['合計消費量'] = `${total_consumption.toFixed(2)} L/M`;
            return individual_consumptions;
        },
        P4(params) {
            const { type } = params;
            if (type === 'flow') {
                const p1 = parseFloat(params.p1);
                const p2 = parseFloat(params.p2);
                const s = parseFloat(params.s);
                const P1_abs = p1 + ATMOSPHERIC_PRESSURE;
                const P2_abs = p2 + ATMOSPHERIC_PRESSURE;
                let Q;
                if (P1_abs / P2_abs >= 1.89) {
                    Q = 11.1 * s * (p1 + ATMOSPHERIC_PRESSURE);
                } else {
                    Q = 22.2 * s * Math.sqrt(P2_abs * (p1 - p2));
                }
                return { "空気流量": `${Q.toFixed(2)} L/M` };
            } else {
                const p = parseFloat(params.p1_bleed);
                const d = parseFloat(params.nozzle_diameter);
                const P_abs = p + ATMOSPHERIC_PRESSURE;
                let Q;
                if (P_abs / ATMOSPHERIC_PRESSURE >= 1.89) {
                    Q = 11.1 * 0.8 * (Math.PI / 4) * d**2 * (p + ATMOSPHERIC_PRESSURE);
                } else {
                    Q = 22.2 * 0.8 * (Math.PI / 4) * d**2 * Math.sqrt(p);
                }
                return { "ブリード量": `${Q.toFixed(2)} L/M` };
            }
        },
        P5(params) {
            const { func, value } = params;
            const val = parseFloat(value);
            let result;
            switch(func) {
                case 'sin': result = Math.sin(val * Math.PI / 180); break;
                case 'cos': result = Math.cos(val * Math.PI / 180); break;
                case 'tan': result = Math.tan(val * Math.PI / 180); break;
                case 'asin': result = Math.asin(val) * 180 / Math.PI; break;
                case 'acos': result = Math.acos(val) * 180 / Math.PI; break;
                case 'atan': result = Math.atan(val) * 180 / Math.PI; break;
            }
            return { [`${func}(${value})`]: result.toFixed(6) };
        },
        P6(params) {
            const { func, value } = params;
            const val = parseFloat(value);
            let result;
            if (func === 'log10') result = Math.log10(val);
            else result = Math.log(val);
            return { [`${func}(${value})`]: result.toFixed(6) };
        },
        SP2(params) {
            const { pressure, flow, length, diameter } = params;
            const DP = (0.2466 * parseFloat(flow)**2 * parseFloat(length)) / (parseFloat(diameter)**5.31 * (parseFloat(pressure) + ATMOSPHERIC_PRESSURE));
            return { "圧力損失": `${DP.toFixed(3)}` };
        },
        SP3(params) {
            const { type, supply_pressure, volume, s, target_pressure, fill_time } = params;
            const P0_abs = parseFloat(supply_pressure) + ATMOSPHERIC_PRESSURE;
            const V = parseFloat(volume);
            const S = parseFloat(s);
            let result;
            if (type === 'fill_time_full') {
                let T;
                if (P0_abs / ATMOSPHERIC_PRESSURE > 1.89) {
                    T = (1.285 - 1 / P0_abs) * (5.21 / 1.4) * (V / S);
                } else {
                    const Px = (ATMOSPHERIC_PRESSURE - P0_abs / 2) / (P0_abs / 2);
                    T = (5.21 / 1.4) * (V / S) * (Math.PI / 2 - Math.asin(Px));
                }
                result = { "充填完了時間": `${T.toFixed(2)} SEC` };
            } else if (type === 'fill_time_to_p') {
                const P_abs = parseFloat(target_pressure) + ATMOSPHERIC_PRESSURE;
                let T;
                if (P0_abs / P_abs >= 1.89) {
                    T = (parseFloat(target_pressure) / (P0_abs - ATMOSPHERIC_PRESSURE)) * (5.21 / 1.4) * (V / S);
                } else {
                    const T_sonic_part = (0.528 - 1 / P0_abs) * (5.21 / 1.4) * (V / S);
                    const Py = (P_abs - P0_abs/2) / (P0_abs/2);
                    const T_subsonic_part = 0.5 * (5.21 / 1.4) * (V / S) * (Math.asin(Py) - 0.056);
                    T = T_sonic_part + T_subsonic_part;
                }
                result = { "P到達時間": `${T.toFixed(2)} SEC` };
            } else {
                const T_fill = parseFloat(fill_time);
                const T_sonic_limit = (5.21 / 1.4) * (V / S) * ((P0_abs / 1.89 - ATMOSPHERIC_PRESSURE) / (P0_abs - ATMOSPHERIC_PRESSURE));
                let P;
                if (T_fill <= T_sonic_limit) {
                    P = (P0_abs - ATMOSPHERIC_PRESSURE) * T_fill * (1.4 / 5.21) * (S / V);
                } else {
                    const sin_arg = (T_fill / (0.5 * (5.21 / 1.4) * (V / S))) + 2 * (0.528 - 1/P0_abs) - 0.056;
                    P = 0.5 * P0_abs * (Math.sin(sin_arg) + 1) - ATMOSPHERIC_PRESSURE;
                }
                result = { "T秒後の圧力": `${P.toFixed(3)}` };
            }
            return result;
        },
        SP4(params) {
            const { type, initial_pressure, volume, s, target_pressure, release_time } = params;
            const P0_abs = parseFloat(initial_pressure) + ATMOSPHERIC_PRESSURE;
            const V = parseFloat(volume);
            const S = parseFloat(s);
            let result;
            if (type === 'release_time_full') {
                 let T;
                if (P0_abs / ATMOSPHERIC_PRESSURE >= 1.89) {
                    T = (7 * (Math.pow(P0_abs / (1.89 * ATMOSPHERIC_PRESSURE), 0.143) - 1) + 0.945 * 1.4) * (5.21 / 1.4) * (V / S);
                } else {
                    T = 5.21 * (V / S) * Math.pow(P0_abs / ATMOSPHERIC_PRESSURE - 1, 0.5);
                }
                result = { "放出完了時間": `${T.toFixed(2)} SEC` };
            } else if (type === 'release_time_to_p') {
                const P_abs = parseFloat(target_pressure) + ATMOSPHERIC_PRESSURE;
                let T;
                 if (P_abs / ATMOSPHERIC_PRESSURE >= 1.89) {
                    T = 7 * (Math.pow(P0_abs / P_abs, 0.143) - 1) * (5.21 / 1.4) * (V / S);
                } else {
                    const T_sonic = 7 * (Math.pow(P0_abs / (1.89 * ATMOSPHERIC_PRESSURE), 0.143) - 1) * (5.21 / 1.4) * (V / S);
                    const T_subsonic = 5.21 * (V / S) * (Math.pow(1.89 - 1, 0.5) - Math.pow(P_abs / ATMOSPHERIC_PRESSURE - 1, 0.5));
                    T = T_sonic + T_subsonic;
                }
                result = { "P到達時間": `${T.toFixed(2)} SEC` };
            } else {
                const T_release = parseFloat(release_time);
                const T_sonic_limit = 7 * (Math.pow(P0_abs / (1.89 * ATMOSPHERIC_PRESSURE), 0.143) - 1) * (5.21 / 1.4) * (V / S);
                let P;
                if (T_release <= T_sonic_limit) {
                    P = P0_abs / Math.pow(T_release / (7 * (5.21 / 1.4) * (V / S)) + 1, 1/0.143) - ATMOSPHERIC_PRESSURE;
                } else {
                    const term = Math.pow(1.89-1, 0.5) - (T_release - T_sonic_limit) / (5.21 * V / S);
                    P = ATMOSPHERIC_PRESSURE * (term**2 + 1) - ATMOSPHERIC_PRESSURE;
                }
                result = { "T秒後の圧力": `${Math.max(0, P).toFixed(3)}` };
            }
            return result;
        }
    };

    function executeCalculation(functionId) {
        const form = document.getElementById(`form-${functionId}`);
        const formData = new FormData(form);
        const params = {};
        for (let [key, value] of formData.entries()) {
            params[key] = value;
        }

        const MPA_TO_KGF = 10.19716;
        const KGF_TO_MPA = 0.0980665;

        const pressureFieldMap = {
            'pressure': 'pressure_unit',
            'p1': 'p1_unit',
            'p2': 'p2_unit',
            'p1_bleed': 'p1_bleed_unit',
            'supply_pressure': 'supply_pressure_unit',
            'target_pressure': 'target_pressure_unit',
            'initial_pressure': 'initial_pressure_unit'
        };
        
        for (const fieldName in pressureFieldMap) {
            if (params[fieldName] && params[fieldName] !== '') {
                const unitFieldName = pressureFieldMap[fieldName];
                if (params[unitFieldName] === 'MPa') {
                    params[fieldName] = parseFloat(params[fieldName]) * MPA_TO_KGF;
                } else {
                    params[fieldName] = parseFloat(params[fieldName]);
                }
            }
        }
        
        if (functionId === 'P3') {
            params.cylinders = [];
            const cylinderGroups = form.querySelectorAll('.cylinder-group');
            cylinderGroups.forEach(group => {
                params.cylinders.push({
                    diameter: group.querySelector('[name=diameter]').value,
                    stroke: group.querySelector('[name=stroke]').value,
                    frequency: group.querySelector('[name=frequency]').value,
                    pipe_length: group.querySelector('[name=pipe_length]').value,
                    pipe_diameter: group.querySelector('[name=pipe_diameter]').value,
                });
            });
        }
        
        try {
            const result = calculator[functionId](params);

            const primaryUnitRadio = form.querySelector('input[name$="_unit"]:checked');
            const primaryUnit = primaryUnitRadio ? primaryUnitRadio.value : 'MPa';

            if (functionId === 'SP2' && result["圧力損失"]) {
                let valueKgf = parseFloat(result["圧力損失"]);
                result["圧力損失"] = primaryUnit === 'MPa' 
                    ? `${(valueKgf * KGF_TO_MPA).toFixed(3)} MPa`
                    : `${valueKgf.toFixed(2)} K/C`;
            }
            if ((functionId === 'SP3' || functionId === 'SP4') && result["T秒後の圧力"]) {
                let valueKgf = parseFloat(result["T秒後の圧力"]);
                 result["T秒後の圧力"] = primaryUnit === 'MPa'
                    ? `${(valueKgf * KGF_TO_MPA).toFixed(3)} MPa`
                    : `${valueKgf.toFixed(2)} K/C`;
            }
            
            displayCalculationResult(functionId, result);
            closeModal(functionId);
        } catch (e) {
            console.error("Calculation Error in " + functionId, e);
            updateSubDisplay("計算エラー", true);
        }
    }

    function displayCalculationResult(functionId, data) {
        clearDisplay('all');
        displayArea.classList.add('function-result-mode');
        const resultText = Object.entries(data).map(([key, value]) => `${key}: ${value}`).join('\n');
        
        subDisplayContent.textContent = resultText;
        subDisplayContent.style.transform = `translateY(0px)`;
        subDisplayScrollTop = 0;

        requestAnimationFrame(() => {
            const containerHeight = subDisplayContainer.clientHeight;
            const contentHeight = subDisplayContent.scrollHeight;
            
            if (contentHeight > containerHeight) {
                scrollIndicator.classList.remove('hidden');
                updateSubDisplayScroll();
            } else {
                scrollIndicator.classList.add('hidden');
            }
        });
        
        isFunctionResultDisplayed = true;
        renderDisplayWithCursor();
    }

    function updateSubDisplayScroll() {
        subDisplayContent.style.transform = `translateY(-${subDisplayScrollTop}px)`;
        scrollUpIndicator.style.visibility = subDisplayScrollTop > 0 ? 'visible' : 'hidden';
        const maxScroll = Math.max(0, subDisplayContent.scrollHeight - subDisplayContainer.clientHeight);
        scrollDownIndicator.style.visibility = subDisplayScrollTop < maxScroll ? 'visible' : 'hidden';
    }
    
    function createModal(id, title, content) {
        return `
            <div id="modal-${id}" class="modal absolute inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
                <div class="modal-content bg-gray-100 rounded-lg shadow-xl w-full max-w-sm p-6 border-2 border-gray-300">
                    <form id="form-${id}" onsubmit="return false;">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">${title}</h2>
                        <div class="space-y-3 text-sm">${content}</div>
                        <div class="mt-6 flex justify-end space-x-3">
                            <button type="button" onclick="closeModal('${id}')" class="key bg-gray-300 text-gray-800 px-4 py-2 font-medium">キャンセル</button>
                            <button type="button" onclick="executeCalculation('${id}')" class="key bg-blue-600 text-white px-4 py-2 font-bold">計算</button>
                        </div>
                    </form>
                </div>
            </div>`;
    }

    function createPressureInput(name, label, defaultValueMpa, unitName) {
        return `
            <div class="input-group">
                <label class="input-label">${label}</label>
                <div class="flex items-center mt-1">
                    <input type="number" name="${name}" class="input-field flex-grow" value="${defaultValueMpa}" step="any">
                    <div class="text-xs pl-2 flex-shrink-0 space-y-1">
                        <label class="flex items-center"><input type="radio" name="${unitName}" value="MPa" checked onchange="handleUnitChange(this)"> <span class="pl-1">MPa</span></label>
                        <label class="flex items-center"><input type="radio" name="${unitName}" value="K/C" onchange="handleUnitChange(this)"> <span class="pl-1">K/C</span></label>
                    </div>
                </div>
            </div>
        `;
    }

    function createAllModals() {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `
            ${createModal('P0', 'シリンダ出力と負荷率', `
                <div onchange="toggleVis('p0-load-inputs', this.querySelector(':checked').value === 'load_rate')">
                    <label class="flex items-center"><input type="radio" name="type" value="output" checked><span class="ml-2">出力のみ</span></label>
                    <label class="flex items-center"><input type="radio" name="type" value="load_rate"><span class="ml-2">負荷率も計算</span></label>
                </div>
                <hr class="my-2">
                ${createPressureInput('pressure', '作動圧力', '0.4', 'pressure_unit')}
                <div class="input-group"><label class="input-label">シリンダ内径 (MM)</label><input type="number" name="cylinder_diameter" class="input-field" value="63"></div>
                <div class="input-group"><label class="input-label">ロッド径 (MM)</label><input type="number" name="rod_diameter" class="input-field" value="24"></div>
                <div id="p0-load-inputs" class="space-y-3 pl-5 hidden">
                    <div class="input-group"><label class="input-label">負荷の重量 (Kgf)</label><input type="number" name="load_weight" class="input-field" value="200"></div>
                    <div class="input-group"><label class="input-label">摩擦係数</label><input type="number" name="load_friction" class="input-field" value="0.3"></div>
                </div>
            `)}
            ${createModal('P1', '運動（動作時間・必要S）', `
                <div onchange="toggleVis('p1-time-inputs', this.querySelector(':checked').value === 'time'); toggleVis('p1-s-inputs', this.querySelector(':checked').value === 'necessary_s')">
                    <label class="flex items-center"><input type="radio" name="type" value="time" checked><span class="ml-2">動作時間を計算</span></label>
                    <label class="flex items-center"><input type="radio" name="type" value="necessary_s"><span class="ml-2">必要有効断面積を計算</span></label>
                </div>
                <div onchange="">
                    <label class="flex items-center"><input type="radio" name="direction" value="push" checked><span class="ml-2">PUSH</span></label>
                    <label class="flex items-center"><input type="radio" name="direction" value="pull"><span class="ml-2">PULL</span></label>
                </div>
                <hr class="my-2">
                <div id="p1-time-inputs">
                    <div class="input-group"><label class="input-label">合成有効断面積S (mm²)</label><input type="number" name="s_composite" class="input-field" value="5.68"></div>
                    <div class="input-group"><label class="input-label">配管容積 ΔV (cm³)</label><input type="number" name="pipe_volume" class="input-field" value="50"></div>
                </div>
                <div id="p1-s-inputs" class="hidden">
                    <div class="input-group"><label class="input-label">目標動作時間 (sec)</label><input type="number" name="time" class="input-field" value="0.8"></div>
                </div>
                ${createPressureInput('pressure', '作動圧力', '0.5', 'pressure_unit')}
                <div class="input-group"><label class="input-label">シリンダ内径 (mm)</label><input type="number" name="cylinder_diameter" class="input-field" value="50"></div>
                <div class="input-group"><label class="input-label">ロッド径 (mm)</label><input type="number" name="rod_diameter" class="input-field" value="20"></div>
                <div class="input-group"><label class="input-label">ストローク (mm)</label><input type="number" name="stroke" class="input-field" value="300"></div>
                <div class="input-group"><label class="input-label">負荷重量 (Kgf)</label><input type="number" name="load_weight" class="input-field" value="49"></div>
                <div class="input-group"><label class="input-label">摩擦係数</label><input type="number" name="load_friction" class="input-field" value="0.4"></div>
            `)}
             ${createModal('P2', '有効断面積', `
                <div onchange="toggleVis('p2-pipe-inputs', this.querySelector(':checked').value === 'pipe'); toggleVis('p2-composite-inputs', this.querySelector(':checked').value === 'composite')">
                    <label class="flex items-center"><input type="radio" name="type" value="pipe" checked><span class="ml-2">配管のS</span></label>
                    <label class="flex items-center"><input type="radio" name="type" value="composite"><span class="ml-2">Sの合成</span></label>
                </div>
                <hr class="my-2">
                <div id="p2-pipe-inputs">
                    <div class="input-group"><label class="input-label">配管長さ (m)</label><input type="number" name="pipe_length" class="input-field" value="3"></div>
                    <div class="input-group"><label class="input-label">配管種類</label><select name="pipe_type" class="input-field"><option value="steel">鋼管</option><option value="nylon">ナイロンチューブ</option></select></div>
                    <div class="input-group"><label class="input-label">配管内径 (mm)</label><input type="number" name="pipe_diameter" class="input-field" value="16.1"></div>
                </div>
                <div id="p2-composite-inputs" class="hidden">
                    <div class="input-group"><label class="input-label">各有効断面積 (カンマ区切り)</label><input type="text" name="s_values" class="input-field" value="15,8,20"></div>
                </div>
            `)}
            ${createModal('P3', '空気消費量', `
                ${createPressureInput('pressure', '作動圧力', '0.4', 'pressure_unit')}
                <div class="input-group"><label class="input-label">シリンダの本数</label><input type="number" name="num_cylinders" class="input-field" value="2" onchange="generateCylinderInputs(this.value)"></div>
                <div id="p3-cylinder-inputs" class="space-y-4"></div>
            `)}
            ${createModal('P4', '流量', `
                <div onchange="toggleVis('p4-flow-inputs', this.querySelector(':checked').value === 'flow'); toggleVis('p4-bleed-inputs', this.querySelector(':checked').value === 'bleed')">
                    <label class="flex items-center"><input type="radio" name="type" value="flow" checked><span class="ml-2">流量</span></label>
                    <label class="flex items-center"><input type="radio" name="type" value="bleed"><span class="ml-2">ブリード量</span></label>
                </div>
                <hr class="my-2">
                <div id="p4-flow-inputs">
                    ${createPressureInput('p1', '1次側圧力', '0.5', 'p1_unit')}
                    ${createPressureInput('p2', '2次側圧力', '0.38', 'p2_unit')}
                    <div class="input-group"><label class="input-label">絞り部のS (mm²)</label><input type="number" name="s" class="input-field" value="10"></div>
                </div>
                <div id="p4-bleed-inputs" class="hidden">
                    ${createPressureInput('p1_bleed', '圧力', '0.3', 'p1_bleed_unit')}
                    <div class="input-group"><label class="input-label">ノズル内径 (mm)</label><input type="number" name="nozzle_diameter" class="input-field" value="0.8"></div>
                </div>
            `)}
            ${createModal('P5', '三角関数', `
                <div class="input-group"><label class="input-label">関数</label><select name="func" class="input-field"><option value="sin">sin</option><option value="cos">cos</option><option value="tan">tan</option><option value="asin">asin</option><option value="acos">acos</option><option value="atan">atan</option></select></div>
                <div class="input-group"><label class="input-label">値 (角度 or -1~1)</label><input type="number" name="value" class="input-field" value="40"></div>
            `)}
            ${createModal('P6', '対数', `
                <div class="input-group"><label class="input-label">関数</label><select name="func" class="input-field"><option value="log10">log10</option><option value="loge">loge</option></select></div>
                <div class="input-group"><label class="input-label">値</label><input type="number" name="value" class="input-field" value="5230"></div>
            `)}
            ${createModal('SP2', '配管の圧力損失', `
                ${createPressureInput('pressure', '元圧力', '0.7', 'pressure_unit')}
                <div class="input-group"><label class="input-label">流量 (l/min)</label><input type="number" name="flow" class="input-field" value="5000"></div>
                <div class="input-group"><label class="input-label">配管長さ (m)</label><input type="number" name="length" class="input-field" value="30"></div>
                <div class="input-group"><label class="input-label">配管内径 (mm)</label><input type="number" name="diameter" class="input-field" value="27.6"></div>
            `)}
            ${createModal('SP3', 'タンクへの空気圧の充填', `
                <div onchange="toggleVis('sp3-p-input', this.querySelector(':checked').value === 'fill_time_to_p'); toggleVis('sp3-t-input', this.querySelector(':checked').value === 'pressure_after_t')">
                    <label><input type="radio" name="type" value="fill_time_full" checked> 充填完了時間</label><br>
                    <label><input type="radio" name="type" value="fill_time_to_p"> Pまで上昇する時間</label><br>
                    <label><input type="radio" name="type" value="pressure_after_t"> T秒後の圧力</label>
                </div>
                <hr class="my-2">
                ${createPressureInput('supply_pressure', '供給圧力', '0.3', 'supply_pressure_unit')}
                <div class="input-group"><label class="input-label">タンク容積 (l)</label><input type="number" name="volume" class="input-field" value="20"></div>
                <div class="input-group"><label class="input-label">絞り部のS (mm²)</label><input type="number" name="s" class="input-field" value="12"></div>
                <div id="sp3-p-input" class="hidden">${createPressureInput('target_pressure', '目標圧力 P', '0.25', 'target_pressure_unit')}</div>
                <div id="sp3-t-input" class="hidden"><div class="input-group"><label class="input-label">充填時間 T (sec)</label><input type="number" name="fill_time" class="input-field" value="3"></div></div>
            `)}
            ${createModal('SP4', 'タンクからの空気圧の放出', `
                 <div onchange="toggleVis('sp4-p-input', this.querySelector(':checked').value === 'release_time_to_p'); toggleVis('sp4-t-input', this.querySelector(':checked').value === 'pressure_after_t')">
                    <label><input type="radio" name="type" value="release_time_full" checked> 放出完了時間</label><br>
                    <label><input type="radio" name="type" value="release_time_to_p"> Pまで下降する時間</label><br>
                    <label><input type="radio" name="type" value="pressure_after_t"> T秒後の圧力</label>
                </div>
                <hr class="my-2">
                ${createPressureInput('initial_pressure', '初期圧力', '0.5', 'initial_pressure_unit')}
                <div class="input-group"><label class="input-label">タンク容積 (l)</label><input type="number" name="volume" class="input-field" value="60"></div>
                <div class="input-group"><label class="input-label">絞り部のS (mm²)</label><input type="number" name="s" class="input-field" value="18"></div>
                <div id="sp4-p-input" class="hidden">${createPressureInput('target_pressure', '目標圧力 P', '0.4', 'target_pressure_unit')}</div>
                <div id="sp4-t-input" class="hidden"><div class="input-group"><label class="input-label">放出時間 T (sec)</label><input type="number" name="release_time" class="input-field" value="2.5"></div></div>
            `)}
        `;
    }

    function generateCylinderInputs(count) {
        const container = document.getElementById('p3-cylinder-inputs');
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            container.innerHTML += `
                <div class="cylinder-group border-t pt-2 mt-2">
                    <h4 class="font-bold mb-2">シリンダ ${i}</h4>
                    <div class="input-group"><label class="input-label">内径 (mm)</label><input type="number" name="diameter" class="input-field" value="40"></div>
                    <div class="input-group"><label class="input-label">ストローク (mm)</label><input type="number" name="stroke" class="input-field" value="100"></div>
                    <div class="input-group"><label class="input-label">動作頻度 (回/min)</label><input type="number" name="frequency" class="input-field" value="12"></div>
                    <div class="input-group"><label class="input-label">配管長さ (m)</label><input type="number" name="pipe_length" class="input-field" value="1"></div>
                    <div class="input-group"><label class="input-label">配管内径 (mm)</label><input type="number" name="pipe_diameter" class="input-field" value="6"></div>
                </div>
            `;
        }
    }

    function toggleSizeLock() {
        isSizeLocked = !isSizeLocked;
        lockIcon.classList.toggle('hidden', isSizeLocked);
        unlockIcon.classList.toggle('hidden', !isSizeLocked);
        if (!isSizeLocked) {
            adjustAppScale();
        }
        updateSubDisplay(isSizeLocked ? '画面サイズ固定 ON' : '画面サイズ固定 OFF', true);
    }

    function adjustAppScale() {
        if (isSizeLocked) return;
        const appContainer = document.getElementById('app-container');
        const baseWidth = 393;
        const baseHeight = 852;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        const scaleX = viewportWidth / baseWidth;
        const scaleY = viewportHeight / baseHeight;

        const scale = Math.min(scaleX, scaleY);

        appContainer.style.transform = `scale(${scale})`;
    }

    document.addEventListener('DOMContentLoaded', () => {
        createAllModals();
        generateCylinderInputs(2);
        renderDisplayWithCursor();
        adjustAppScale();
    });
    window.addEventListener('resize', adjustAppScale);
</script>
</body>
</html>
